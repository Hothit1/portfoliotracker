<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Portfolio Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .table-glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        th, td {
            color: #E5E7EB; /* Lighter text for dark bg */
        }
        thead {
             background: rgba(255, 255, 255, 0.15) !important;
        }
         tbody tr:nth-child(even) {
            background: rgba(0, 0, 0, 0.05);
        }
        tbody tr:hover {
            background: rgba(255, 255, 255, 0.2) !important;
        }
        tfoot {
            background: rgba(255, 255, 255, 0.15) !important;
        }
        ::placeholder {
            color: #D1D5DB;
        }
        input {
            background-color: rgba(0,0,0,0.2);
            border-color: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body class="flex items-center justify-center p-4 text-white">
    <div id="app" class="container mx-auto max-w-6xl">
        <h1 class="text-4xl font-bold mb-8 text-center text-white tracking-wide">Crypto Portfolio Tracker</h1>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div id="portfolioSummary" class="glass-card rounded-xl shadow-2xl p-6">
                <h2 class="text-2xl font-semibold mb-4 text-white">Your Portfolio</h2>
                <div class="flex items-center justify-center">
                    <p id="totalValue" class="text-3xl font-bold text-green-400">$0.00</p>
                    <button onclick="toggleTotalValue()" class="ml-4 bg-gray-500/50 text-white px-2 py-1 rounded-md hover:bg-gray-400/50 transition">
                        Show
                    </button>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-200">Target Value:</label>
                    <div class="flex items-center mt-2">
                        <input type="number" id="targetValue" value="1000000" class="w-32 px-2 py-1 border rounded mr-2">
                        <button onclick="updateTarget()" class="bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 transition">Set Target</button>
                    </div>
                    <div class="mt-4">
                        <div class="relative pt-1">
                            <div class="flex mb-2 items-center justify-between">
                                <div><span id="progressPercentage" class="text-xs font-semibold inline-block text-blue-300">0%</span></div>
                                <div class="text-right"><span id="remainingValue" class="text-xs font-semibold inline-block text-blue-300">Remaining: $0</span></div>
                            </div>
                            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-blue-200/50">
                                <div id="progressBar" class="progress-bar shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="flex items-center mt-4">
                    <button onclick="manualRefresh()" id="refreshButton" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition flex items-center">
                        <svg id="refreshSpinner" class="spinner h-5 w-5 mr-2 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 9a9 9 0 0114.95-4.95l.05.05M20 15a9 9 0 01-14.95 4.95l-.05-.05"></path></svg>
                        Refresh Prices
                    </button>
                    <p id="lastUpdated" class="ml-4 text-sm text-gray-300">Last updated: Never</p>
                </div>
            </div>
            <div class="glass-card rounded-xl shadow-2xl p-6 flex items-center justify-center">
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>
        <div class="glass-card rounded-xl shadow-2xl p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-white">Add New Coin</h2>
            <div class="flex flex-col md:flex-row items-center">
                <input type="text" id="newCoinId" placeholder="Enter Coin ID (e.g., solana)" class="w-full md:w-1/2 px-3 py-2 border rounded mr-4 mb-4 md:mb-0">
                <button onclick="addNewCoin()" class="bg-indigo-500 text-white px-4 py-2 rounded-md hover:bg-indigo-600 transition w-full md:w-auto">Add Coin</button>
            </div>
            <p class="mt-2 text-sm text-gray-300">* Use CoinGecko Coin ID (e.g., "bitcoin", "ethereum"). <a href="https://www.coingecko.com/en" target="_blank" class="text-blue-400 underline">Find Coin IDs here</a>.</p>
        </div>
        <div class="table-glass rounded-xl shadow-2xl p-6 overflow-x-auto">
            <table class="min-w-full">
                <thead class="text-gray-300">
                    <tr>
                        <th class="py-3 px-4 text-left rounded-tl-lg">Name</th>
                        <th class="py-3 px-4 text-left">Price (USD)</th>
                        <th class="py-3 px-4 text-left">24h Change</th>
                        <th class="py-3 px-4 text-left">Holdings</th>
                        <th class="py-3 px-4 text-left">Portfolio %</th>
                        <th class="py-3 px-4 text-left">Target Price</th>
                        <th class="py-3 px-4 text-left">Predicted Value</th>
                        <th class="py-3 px-4 text-left">Predicted Mkt Cap</th>
                        <th class="py-3 px-4 text-left rounded-tr-lg">Actions</th>
                    </tr>
                </thead>
                <tbody id="cryptoTableBody">
                    <tr>
                        <td colspan="9" class="text-center py-10">
                             <div class="flex justify-center items-center">
                                <svg class="spinner h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 9a9 9 0 0114.95-4.95l.05.05M20 15a9 9 0 01-14.95 4.95l-.05-.05"></path></svg>
                                <span class="ml-4 text-lg">Loading Initial Data...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
                <tfoot class="text-gray-300">
                    <tr>
                        <td colspan="5" class="py-3 px-4 text-right font-semibold">Total Predicted Value:</td>
                        <td colspan="2" class="py-3 px-4 font-semibold" id="totalPredictedValue">$0.00</td>
                        <td></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <p class="text-center mt-6 text-sm text-white opacity-75">Data from CoinGecko. Auto-refreshes every 60 seconds.</p>
    </div>

    <script>
        let cryptoData = [];
        let portfolio = {};
        let targetPrices = {};
        let chart;
        let targetValue = 1000000;
        let isTotalValueHidden = true;
        const REFRESH_INTERVAL = 60000; // 60 seconds

        window.onload = function() {
            loadPortfolio();
            loadTarget();
            loadTargetPrices();
            initializeDefaultCryptos(); // This will load saved coins as well
            setInterval(refreshPrices, REFRESH_INTERVAL); // Auto-refresh prices
        };

        function loadAddedCoins() {
            const savedAddedCoins = localStorage.getItem('addedCoins');
            return savedAddedCoins ? JSON.parse(savedAddedCoins) : [];
        }

        function saveAddedCoins() {
            const addedCoins = cryptoData.map(crypto => crypto.id);
            localStorage.setItem('addedCoins', JSON.stringify(addedCoins));
        }

        function loadTargetPrices() {
            const savedTargetPrices = localStorage.getItem('targetPrices');
            if (savedTargetPrices) targetPrices = JSON.parse(savedTargetPrices);
        }

        function saveTargetPrices() {
            localStorage.setItem('targetPrices', JSON.stringify(targetPrices));
        }

        function toggleTotalValue() {
            isTotalValueHidden = !isTotalValueHidden;
            const toggleButton = document.querySelector('#portfolioSummary button');
            toggleButton.textContent = isTotalValueHidden ? 'Show' : 'Hide';
            updatePortfolioValue();
        }

        function loadTarget() {
            const savedTarget = localStorage.getItem('targetValue');
            if (savedTarget) {
                targetValue = parseFloat(savedTarget);
                document.getElementById('targetValue').value = targetValue;
            }
        }

        function updateTarget() {
            const newTarget = parseFloat(document.getElementById('targetValue').value);
            if (!isNaN(newTarget) && newTarget > 0) {
                targetValue = newTarget;
                localStorage.setItem('targetValue', targetValue);
                updateProgressBar();
            }
        }

        function updateProgressBar() {
            const totalValue = calculateTotalValue();
            const percentage = (totalValue / targetValue) * 100;
            const remaining = targetValue > totalValue ? targetValue - totalValue : 0;
            document.getElementById('progressBar').style.width = `${Math.min(100, percentage)}%`;
            document.getElementById('progressPercentage').textContent = `${percentage.toFixed(2)}%`;
            document.getElementById('remainingValue').textContent = `Remaining: $${remaining.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        async function initializeDefaultCryptos() {
            const defaultCryptos = ['bitcoin', 'pepe', 'hyperliquid'];
            const savedCoins = loadAddedCoins();
            // Use Set to ensure unique coin IDs
            const uniqueCoinIds = new Set([...defaultCryptos, ...savedCoins]);

            try {
                // Fetch all coins in parallel for faster loading
                await Promise.all([...uniqueCoinIds].map(id => fetchAndAddCoin(id, false)));
                updateUI();
                
                // Set initial hidden state for total value
                document.getElementById('totalValue').textContent = '****';
                document.querySelector('#portfolioSummary button').textContent = 'Show';
            } catch (error) {
                console.error('Failed to initialize cryptocurrencies:', error);
                document.getElementById('cryptoTableBody').innerHTML = `<td colspan="9" class="text-center text-red-400 py-10">Failed to load coin data. Please check your connection and refresh.</td>`;
            }
        }

        async function fetchAndAddCoin(cryptoId, shouldUpdateUI = true) {
             if (cryptoData.some(c => c.id === cryptoId)) return; // Avoid duplicates
            try {
                const response = await axios.get(`https://api.coingecko.com/api/v3/coins/${cryptoId}`);
                const data = response.data;
                cryptoData.push({
                    id: data.id,
                    symbol: data.symbol,
                    name: data.name,
                    image: data.image.small,
                    current_price: data.market_data.current_price.usd,
                    price_change_percentage_24h: data.market_data.price_change_percentage_24h,
                    market_cap: data.market_data.market_cap.usd,
                    circulating_supply: data.market_data.circulating_supply
                });
                if (shouldUpdateUI) updateUI();
            } catch (error) {
                console.error(`Failed to fetch data for coin ID "${cryptoId}":`, error);
                alert(`Failed to add coin "${cryptoId}". Please ensure the Coin ID is correct.`);
            }
        }

        function loadPortfolio() {
            const savedPortfolio = localStorage.getItem('cryptoPortfolio');
            if (savedPortfolio) portfolio = JSON.parse(savedPortfolio);
        }

        function savePortfolio() {
            localStorage.setItem('cryptoPortfolio', JSON.stringify(portfolio));
        }

        const calculateTotalValue = () => cryptoData.reduce((total, crypto) => total + (portfolio[crypto.id] || 0) * crypto.current_price, 0);
        const calculateTotalPredictedValue = () => cryptoData.reduce((sum, crypto) => sum + (portfolio[crypto.id] || 0) * (targetPrices[crypto.id] || crypto.current_price), 0);
        
        function manualRefresh() {
             refreshPrices();
        }

        async function refreshPrices() {
            const spinner = document.getElementById('refreshSpinner');
            const refreshButton = document.getElementById('refreshButton');
            spinner.classList.remove('hidden');
            refreshButton.disabled = true;

            try {
                await Promise.all(cryptoData.map(async (crypto) => {
                    const response = await axios.get(`https://api.coingecko.com/api/v3/coins/${crypto.id}`);
                    const data = response.data.market_data;
                    crypto.current_price = data.current_price.usd;
                    crypto.price_change_percentage_24h = data.price_change_percentage_24h;
                    crypto.circulating_supply = data.circulating_supply;
                    crypto.market_cap = data.market_cap.usd;
                }));
                document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                updateUI();
            } catch (error) {
                console.error('Failed to refresh prices:', error);
                alert('Failed to refresh prices. API limit might be reached. Please try again later.');
            } finally {
                spinner.classList.add('hidden');
                refreshButton.disabled = false;
            }
        }
        
        async function addNewCoin() {
            const input = document.getElementById('newCoinId');
            const cryptoId = input.value.trim().toLowerCase();
            if (!cryptoId) return alert('Please enter a valid Coin ID.');
            if (cryptoData.some(c => c.id === cryptoId)) return alert('Coin already exists.');
            
            await fetchAndAddCoin(cryptoId);
            saveAddedCoins();
            input.value = '';
        }

        function removeCoin(cryptoId) {
            if (!confirm(`Are you sure you want to remove this coin?`)) return;
            cryptoData = cryptoData.filter(c => c.id !== cryptoId);
            delete portfolio[cryptoId];
            delete targetPrices[cryptoId];
            savePortfolio();
            saveTargetPrices();
            saveAddedCoins();
            updateUI();
        }
        
        function updateUI() {
            renderTable();
            updatePortfolioValue();
            updateChart();
            updateProgressBar();
        }

        function renderTable() {
            const tbody = document.getElementById('cryptoTableBody');
            if (cryptoData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center py-10">Your portfolio is empty. Add a coin to get started!</td></tr>`;
                return;
            }
            tbody.innerHTML = ''; 

            const totalValue = calculateTotalValue();

            cryptoData.forEach(crypto => {
                const holdings = portfolio[crypto.id] || 0;
                const value = holdings * crypto.current_price;
                const percentage = totalValue > 0 ? (value / totalValue * 100).toFixed(2) : '0.00';
                const targetPrice = targetPrices[crypto.id] || '';
                const predictedValue = holdings * (targetPrice || crypto.current_price);
                const predictedMarketCap = (targetPrice || crypto.current_price) * crypto.circulating_supply;
                const change_24h = crypto.price_change_percentage_24h || 0;

                const row = document.createElement('tr');
                row.className = 'hover:bg-white/10 transition-colors duration-150';
                row.innerHTML = `
                    <td class="py-4 px-4"><div class="flex items-center"><img src="${crypto.image}" alt="${crypto.name}" class="w-8 h-8 mr-3 rounded-full"><div class="font-medium">${crypto.name}<div class="text-sm text-gray-400">${crypto.symbol.toUpperCase()}</div></div></div></td>
                    <td class="py-4 px-4 font-semibold">$${formatPrice(crypto.current_price)}</td>
                    <td class="py-4 px-4"><span class="px-2 py-1 text-sm rounded ${change_24h >= 0 ? 'bg-green-500/30 text-green-300' : 'bg-red-500/30 text-red-300'}">${change_24h >= 0 ? '▲' : '▼'} ${Math.abs(change_24h).toFixed(2)}%</span></td>
                    <td class="py-4 px-4">${holdings.toLocaleString()}</td>
                    <td class="py-4 px-4">${percentage}%</td>
                    <td class="py-4 px-4"><div class="flex items-center"><input type="number" step="any" id="target-${crypto.id}" value="${targetPrice}" placeholder="e.g., 80000" class="w-24 px-2 py-1 border rounded mr-2"><button onclick="updateTargetPrice('${crypto.id}')" class="bg-purple-500 text-white p-1 rounded hover:bg-purple-600 text-xs" title="Set Target Price">✔️</button></div></td>
                    <td class="py-4 px-4">$${formatPrice(predictedValue)}</td>
                    <td class="py-4 px-4">$${formatPrice(predictedMarketCap)}</td>
                    <td class="py-4 px-4"><div class="flex items-center"><input type="number" step="any" id="input-${crypto.id}" placeholder="Amount" class="w-20 px-2 py-1 border rounded mr-2"><button onclick="updateHoldings('${crypto.id}')" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600" title="Update Holdings"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button><button onclick="removeCoin('${crypto.id}')" class="ml-2 bg-red-500 text-white p-2 rounded hover:bg-red-600" title="Remove Coin"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></div></td>
                `;
                tbody.appendChild(row);
            });
            document.getElementById('totalPredictedValue').textContent = `$${formatPrice(calculateTotalPredictedValue())}`;
        }

        function formatPrice(price) {
            if (price >= 1000) return price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (price >= 1) return price.toFixed(2);
            if (price >= 0.001) return price.toFixed(4);
            return price.toPrecision(4);
        }

        function updateHoldings(cryptoId) {
            const inputElement = document.getElementById(`input-${cryptoId}`);
            const amount = parseFloat(inputElement.value);
            if (!isNaN(amount) && amount >= 0) {
                portfolio[cryptoId] = amount;
                savePortfolio();
                updateUI();
                inputElement.value = '';
            } else {
                alert('Please enter a valid number.');
            }
        }

        function updateTargetPrice(cryptoId) {
            const inputElement = document.getElementById(`target-${cryptoId}`);
            const target = parseFloat(inputElement.value);
            if (!isNaN(target) && target > 0) {
                targetPrices[cryptoId] = target;
                saveTargetPrices();
                renderTable(); // Only need to re-render table for this
            } else if (inputElement.value === '') { // Allow clearing the target
                delete targetPrices[cryptoId];
                saveTargetPrices();
                renderTable();
            } else {
                alert('Please enter a valid target price.');
            }
        }

        function updatePortfolioValue() {
            const totalValue = calculateTotalValue();
            const totalValueElement = document.getElementById('totalValue');
            totalValueElement.textContent = isTotalValueHidden ? '****' : `$${formatPrice(totalValue)}`;
        }

        function updateChart() {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            const data = cryptoData.map(crypto => ({
                name: crypto.name,
                value: (portfolio[crypto.id] || 0) * crypto.current_price
            })).filter(item => item.value > 0);

            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'doughnut', // Changed to doughnut
                data: {
                    labels: data.map(item => item.name),
                    datasets: [{
                        data: data.map(item => item.value),
                        backgroundColor: ['#6366F1', '#EC4899', '#22D3EE', '#F59E0B', '#84CC16', '#EF4444', '#14B8A6', '#A855F7'],
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#E5E7EB', // Lighter legend text
                                font: { size: 14 }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Portfolio Distribution',
                            color: '#FFFFFF', // White title
                            font: { size: 18, weight: '600' }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
